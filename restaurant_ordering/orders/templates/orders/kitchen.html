<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>å¨æˆ¿è®¢å•</title>
</head>
<body>
    <h1>å¨æˆ¿è®¢å•</h1>
    <ul id="order-list"></ul> <!-- è®¢å•åˆ—è¡¨ -->

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            fetchOrders();  // é¡µé¢åŠ è½½æ—¶è·å–è®¢å•
            setInterval(fetchOrders, 5000);  // æ¯ 5 ç§’åˆ·æ–°è®¢å•
        });

        function fetchOrders() {
           fetch("/api/orders/")   // ç¡®ä¿è·¯å¾„åŒ¹é… Django `urls.py`
                .then(response => response.json())
                .then(data => {
                    console.log("ğŸ”¥ è®¢å•æ•°æ®:", data);  // ç¡®ä¿æ‹¿åˆ°äº†æ•°æ®
                    renderOrders(data);  // è°ƒç”¨å‡½æ•°æ¸²æŸ“æ•°æ®
                })
                .catch(error => console.error("åŠ è½½è®¢å•æ—¶å‡ºé”™:", error));
        }

        function renderOrders(orders) {
            const orderList = document.getElementById("order-list");
            orderList.innerHTML = "";  // æ¸…ç©ºåˆ—è¡¨

            orders.forEach(order => {
                let orderElement = document.createElement("li");
                orderElement.innerHTML = `<strong>è®¢å• ID:</strong> ${order.id} | <strong>çŠ¶æ€:</strong> ${order.status}`;

                // **æ£€æŸ¥ items æ˜¯å¦å­˜åœ¨**
                if (!order.items || order.items.length === 0) {
                    orderElement.innerHTML += " ï¼ˆæ— èœå“ï¼‰";
                } else {
                    let itemList = document.createElement("ul");
                    order.items.forEach(item => {
                        let itemElement = document.createElement("li");
                        itemElement.textContent = `${item.name} - æ•°é‡: ${item.quantity}`;
                        itemList.appendChild(itemElement);
                    });
                    orderElement.appendChild(itemList);
                }

                // **æ·»åŠ  "æ ‡è®°å®Œæˆ" æŒ‰é’®**
                if (order.status !== "Completed") {
                    let completeButton = document.createElement("button");
                    completeButton.textContent = "æ ‡è®°å®Œæˆ";
                    completeButton.onclick = () => markCompleted(order.id); // ç»‘å®šç‚¹å‡»äº‹ä»¶
                    orderElement.appendChild(completeButton);
                }

                orderList.appendChild(orderElement);
            });
        }

        function markCompleted(orderId) {
            fetch(`/api/orders/${orderId}/`, {
                method: "PATCH",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": getCSRFToken()  // éœ€è¦ CSRF ä»¤ç‰Œ
                },
                body: JSON.stringify({ status: "Completed" })  // è®¾ä¸ºå®Œæˆ
            })
            .then(response => response.json())
            .then(data => {
                console.log(`âœ… è®¢å• ${orderId} å·²æ ‡è®°ä¸ºå®Œæˆ`, data);
                fetchOrders(); // é‡æ–°è·å–è®¢å•åˆ—è¡¨ï¼Œåˆ·æ–°é¡µé¢
            })
            .catch(error => console.error("æ›´æ–°è®¢å•çŠ¶æ€æ—¶å‡ºé”™:", error));
        }

        function getCSRFToken() {
            let cookieValue = null;
            document.cookie.split(";").forEach(cookie => {
                let [name, value] = cookie.trim().split("=");
                if (name === "csrftoken") {
                    cookieValue = decodeURIComponent(value);
                }
            });
            return cookieValue;
        }
    </script>
</body>
</html>




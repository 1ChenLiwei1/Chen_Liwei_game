<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>厨房订单</title>
</head>
<body>
    <h1>厨房订单</h1>
    <ul id="order-list"></ul> <!-- 确保这个 ID 存在 -->

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            console.log("DOM 已加载");
            fetchOrders();
            setInterval(fetchOrders, 5000);
        });

        function fetchOrders() {
            fetch("/kitchen/")
                .then(response => response.json())
                .then(data => {
                    console.log("订单数据:", data);  // 确保数据正确获取
                    let orderList = document.getElementById("order-list");

                    if (!orderList) {
                        console.error("order-list 元素未找到");
                        return;
                    }

                    orderList.innerHTML = "";  // 清空列表
                    data.forEach(order => {
                        let orderElement = document.createElement("li");
                        let itemList = order.items.map(item => `${item.name} x ${item.quantity}`).join(", ");
                        orderElement.innerHTML = `订单 ${order.id} - 状态: ${order.status}
                            <br> 菜品: ${itemList}
                            <br><button onclick="markComplete(${order.id})">标记完成</button>`;
                        orderList.appendChild(orderElement);
                    });
                })
                .catch(error => console.error("加载订单时出错:", error));
        }

        function markComplete(orderId) {
            fetch(`/api/orders/update/${orderId}/`, {
                method: "POST",
                headers: {
                    "X-CSRFToken": getCSRFToken(),
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({ status: "Completed" })
            })
            .then(() => fetchOrders())
            .catch(error => console.error("更新订单失败:", error));
        }

        function getCSRFToken() {
            let cookieValue = null;
            if (document.cookie && document.cookie !== "") {
                document.cookie.split(";").forEach(cookie => {
                    let [name, value] = cookie.trim().split("=");
                    if (name === "csrftoken") {
                        cookieValue = decodeURIComponent(value);
                    }
                });
            }
            return cookieValue;
        }

        // 让 fetchOrders 在 Console 可用
        window.fetchOrders = fetchOrders;
    </script>
</body>
</html>




